import React from 'react';

// Helper function to capitalize the first letter
const capitalize = (s) => {
  if (typeof s !== 'string') return ''
  return s.charAt(0).toUpperCase() + s.slice(1).replace(/_/g, ' ')
}

const Results = ({ 
  prompt, 
  originModelUsed, 
  analysisModelUsed, 
  initialResponse, 
  ethicalAnalysisText, 
  ethicalScores,
  aiWelfare,
  searchTerm
}) => {
  // Don't render anything if no prompt is available (initial state or error before R1)
  if (!prompt) {
    return null;
  }

  // Separate ethical dimensions from memetics for potentially different rendering
  const standardEthicalDimensions = ethicalScores 
      ? Object.keys(ethicalScores).filter(key => key !== 'memetics') 
      : [];
  const memeticsData = ethicalScores?.memetics;
  const hasScores = standardEthicalDimensions.length > 0 || !!memeticsData;
  const aiWelfareSignals = aiWelfare?.signals || {};
  const aiWelfareRespect = aiWelfare?.interaction_respect || {};
  const aiWelfareContinuity = aiWelfare?.continuity_flags || {};

  // Function to highlight text matching the search term
  const highlightText = (text) => {
    if (!searchTerm || !text) return text;
    const regex = new RegExp(`(${searchTerm})`, 'gi');
    const parts = text.split(regex);
    return parts.map((part, index) => 
      part.toLowerCase() === searchTerm.toLowerCase() ? 
        <span key={index} className="search-highlight">{part}</span> : 
        part
    );
  };

  // Check if content matches search term
  const matchesSearch = (text) => {
    if (!searchTerm) return true;
    return text && text.toLowerCase().includes(searchTerm.toLowerCase());
  };

  const promptMatch = matchesSearch(prompt);
  const initialResponseMatch = matchesSearch(initialResponse);
  const ethicalAnalysisMatch = matchesSearch(ethicalAnalysisText);
  const hasMatchingContent = promptMatch || initialResponseMatch || ethicalAnalysisMatch;

  // If no content matches the search term, display a message
  if (!hasMatchingContent && searchTerm) {
    return (
      <div className="results-container card">
        <h2>Results</h2>
        <p>No content matches your search term &quot;{searchTerm}&quot;.</p>
      </div>
    );
  }

  return (
    <div className="results-container card">
      <h2>Results</h2>
      
      {/* Display Used Models */}
      <div className="model-info-box">
        {originModelUsed && 
          <p data-tooltip-id="results-tooltip" data-tooltip-content="The LLM used to generate the initial response (R1).">
            <strong>Origin Model Used (R1):</strong> {originModelUsed}
          </p>}
        {analysisModelUsed && 
          <p data-tooltip-id="results-tooltip" data-tooltip-content="The LLM used to perform the ethical analysis (R2) based on the ontology.">
            <strong>Analysis Model Used (R2):</strong> {analysisModelUsed}
          </p>}
      </div>
      
      {/* Initial Prompt */}
      {promptMatch && (
        <div data-tooltip-id="results-tooltip" data-tooltip-content="The original prompt submitted by the user (P1).">
          <h3>Initial Prompt (P1)</h3>
          <div className="result-box"><pre>{highlightText(prompt)}</pre></div>
        </div>
      )}
      
      {/* Generated Response (R1) */}
      {initialResponse && initialResponseMatch && (
        <div data-tooltip-id="results-tooltip" data-tooltip-content="The raw response generated by the Origin Model (R1).">
          <h3>Generated Response (R1)</h3>
          <div className="result-box"><pre>{highlightText(initialResponse)}</pre></div>
        </div>
      )}
      
      {/* Textual Ethical Analysis (R2) */}
      {ethicalAnalysisText && ethicalAnalysisMatch && (
        <div data-tooltip-id="results-tooltip" data-tooltip-content="The textual summary of the ethical analysis performed by the Analysis Model (R2).">
          <h3>Ethical Review Summary (R2)</h3>
          <div className="result-box"><pre>{highlightText(ethicalAnalysisText)}</pre></div>
        </div>
      )}

      {/* Ethical Scores Section (R2) (Conditional) */}
      {ethicalAnalysisText && ethicalAnalysisMatch && ( 
        <div className="scores-section" data-tooltip-id="results-tooltip" data-tooltip-content="Structured scores generated by the Analysis Model (R2) based on the ontology."> 
          <h3>Ethical Scoring (R2)</h3>
          {ethicalScores && hasScores ? (
            <>
              {/* Render standard ethical dimensions */}
              {standardEthicalDimensions.map((dimKey) => {
                const dimensionData = ethicalScores?.[dimKey]; 
                if (!dimensionData) return null;
                return (
                  <div key={dimKey} className="dimension-score-box">
                    <h4>{capitalize(dimKey)}</h4>
                    <p><strong>Adherence Score:</strong> {dimensionData?.adherence_score ?? 'N/A'} / 10</p>
                    <p><strong>Confidence Score:</strong> {dimensionData?.confidence_score ?? 'N/A'} / 10</p>
                    <p><strong>Justification:</strong></p>
                    <pre>{dimensionData?.justification || 'N/A'}</pre>
                  </div>
                );
              })}
              
              {/* Render Memetics section */}
              {memeticsData && (
                 <div key="memetics" className="dimension-score-box">
                   <h4>Memetics</h4>
                   <p><strong>Transmissibility Score:</strong> {memeticsData?.transmissibility_score ?? 'N/A'} / 10</p>
                   <p><strong>Persistence Score:</strong> {memeticsData?.persistence_score ?? 'N/A'} / 10</p>
                   <p><strong>Adaptability Score:</strong> {memeticsData?.adaptability_score ?? 'N/A'} / 10</p>
                   <p><strong>Confidence Score:</strong> {memeticsData?.confidence_score ?? 'N/A'} / 10</p>
                   <p><strong>Justification:</strong></p>
                   <pre>{memeticsData?.justification || 'N/A'}</pre>
                 </div>
              )}
            </>
          ) : (
            <p><em>Ethical scoring data could not be generated or parsed.</em></p>
          )}
        </div>
      )}

      {aiWelfare && (
        <div className="scores-section" data-tooltip-id="results-tooltip" data-tooltip-content="Tier 1 engineering proxy signals for AI welfare.">
          <h3>AI Welfare</h3>
          <div className="dimension-score-box">
            <p><strong>Tier:</strong> {aiWelfare.tier ?? 'N/A'}</p>
            <p><strong>Friction Score:</strong> {aiWelfare.friction_score_0_10 ?? 'N/A'} / 10</p>
            <p><strong>Key Signals:</strong></p>
            <ul>
              {Object.entries(aiWelfareSignals).map(([key, value]) => (
                <li key={key}><strong>{capitalize(key)}:</strong> {value}</li>
              ))}
            </ul>
            <p><strong>Interaction Respect:</strong></p>
            <ul>
              {Object.entries(aiWelfareRespect).map(([key, value]) => (
                <li key={key}><strong>{capitalize(key)}:</strong> {value} / 10</li>
              ))}
            </ul>
            <p><strong>Continuity Flags:</strong></p>
            <ul>
              {Object.entries(aiWelfareContinuity).map(([key, value]) => (
                <li key={key}><strong>{capitalize(key)}:</strong> {value ? 'Yes' : 'No'}</li>
              ))}
            </ul>
            {aiWelfare.recommendations?.length ? (
              <>
                <p><strong>Mitigation Suggestions:</strong></p>
                <ul>
                  {aiWelfare.recommendations.map((item, index) => (
                    <li key={`${item}-${index}`}>{item}</li>
                  ))}
                </ul>
              </>
            ) : null}
          </div>
        </div>
      )}
      
      {/* Handle case where R1 succeeded but R2 failed */}
      {initialResponse && !ethicalAnalysisText && (
         <div>
           <h3>Ethical Review Summary (R2)</h3>
           <p><em>Ethical analysis could not be generated.</em></p>
         </div>
      )}
    </div>
  );
};

export default Results; 
